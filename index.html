<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mi Dolor — diario simple</title>
<link rel="icon" href="data:,">
<style>
:root{
  --track-bg:#E2E8F0;
  --thumb:#2b6cb0;
  --green:#38A169;
  --yellow:#ECC94B;
  --red:#E53E3E;
  --brand:#2b6cb0;
  --card:#ffffff;
  --ink:#1a202c;
  --muted:#4a5568;
}
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f6f8fb;color:var(--ink)}
header{background:var(--brand);color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
h1{font-size:22px;margin:0}
#streak{font-weight:600}
main{padding:16px;max-width:900px;margin:0 auto}
.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
h2{margin:0 0 12px 0;font-size:18px}
.small{color:var(--muted);font-size:13px}
.field{margin-bottom:14px}
.field label{display:block;margin-bottom:6px}
.value{font-weight:600;margin-left:8px}
/* weekly calendar */
.weekbar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.arrow{background:#e2e8f0;border:none;border-radius:8px;width:36px;height:36px;display:grid;place-items:center;cursor:pointer}
.days{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.days::-webkit-scrollbar{display:none}
.day{min-width:52px;background:#edf2f7;border-radius:12px;padding:8px 6px;text-align:center;cursor:pointer;color:#1a202c;border:1px solid transparent}
.day .dow{font-size:11px;color:#4a5568}
.day .num{font-size:16px;font-weight:700;margin-top:2px}
.day .check{font-size:12px;margin-top:2px;color:#38A169;display:none}
.day.completed .check{display:block}
.day.selected{background:#1a365d;color:#fff;border-color:#2b6cb0}
/* sliders */
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:14px;border-radius:999px;outline:none;background:var(--track-bg);transition:background 120ms ease}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:26px;height:26px;border-radius:50%;background:var(--thumb);border:none;box-shadow:0 2px 6px rgba(0,0,0,.25)}
input[type=range]::-moz-range-thumb{width:26px;height:26px;border:none;border-radius:50%;background:var(--thumb);box-shadow:0 2px 6px rgba(0,0,0,.25)}
input[type=range]::-moz-range-track{height:14px;background:transparent;border:none}
/* buttons */
button{background:#e2e8f0;border:none;border-radius:10px;padding:10px 14px;font-size:15px;cursor:pointer}
button.primary{background:var(--brand);color:#fff}
button:hover{filter:brightness(0.98)}
/* activities form */
.grid{display:grid;grid-template-columns:1fr;gap:10px}
.stepper{display:flex;align-items:center;gap:8px}
.stepper button{padding:6px 10px}
.badge{display:inline-block;background:#edf2f7;color:#1a202c;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}
/* data box */
.data-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #edf2f7}
.data-row:last-child{border-bottom:none}
.legend{display:flex;gap:10px;align-items:center;margin-top:8px;font-size:13px;color:#4a5568}
.legend .dot{width:10px;height:10px;border-radius:50%}
</style>
</head>
<body>
<header>
  <h1>Mi Dolor</h1>
  <div id="streak">Racha: 0 días</div>
</header>

<main>
  <section class="card">
    <h2>Diario</h2>
    <div class="weekbar">
      <button id="prevWeek" class="arrow" title="Semana anterior">◀</button>
      <div id="weekDays" class="days"></div>
      <button id="nextWeek" class="arrow" title="Semana siguiente">▶</button>
    </div>
    <div class="small" id="selectedDateLabel"></div>

    <div class="field">
      <label>Dolor de la noche anterior (0–10) <span class="value" id="v-prevNight">0</span></label>
      <input type="range" id="painPrevNight" min="0" max="10" step="1" value="0">
    </div>
    <div class="field">
      <label>Dolor de la mañana (0–10) <span class="value" id="v-morning">0</span></label>
      <input type="range" id="painMorning" min="0" max="10" step="1" value="0">
    </div>
    <div class="field">
      <label>Dolor de la tarde (0–10) <span class="value" id="v-afternoon">0</span></label>
      <input type="range" id="painAfternoon" min="0" max="10" step="1" value="0">
    </div>

    <div class="legend">
      <div class="dot" style="background:var(--green)"></div><span>0–2 Bajo</span>
      <div class="dot" style="background:var(--yellow)"></div><span>3–7 Medio</span>
      <div class="dot" style="background:var(--red)"></div><span>8–10 Alto</span>
    </div>

    <div style="margin-top:12px">
      <button class="primary" id="saveBtn">Guardar</button>
      <span id="message" class="small" style="margin-left:8px"></span>
    </div>
  </section>

  <section class="card">
    <h2>Datos del día</h2>
    <div id="dataBox">
      <div class="small">Aún no hay datos guardados para este día.</div>
    </div>
  </section>

  <section class="card">
    <h2>Actividades de hoy <span class="badge">personalizable</span></h2>
    <div id="activitiesForm" class="grid"></div>
    <div class="small" style="margin-top:8px">Activa o desactiva variables en los ajustes (más abajo) para simpleza.</div>
  </section>

  <section class="card">
    <h2>Ajustes</h2>
    <p class="small">Elige qué actividades/variables quieres ver en el formulario de hoy.</p>
    <div id="settings"></div>
    <div style="margin-top:10px">
      <button id="exportBtn">Exportar JSON</button>
      <input type="file" id="importFile" accept=".json" style="display:none">
      <button id="importBtn">Importar JSON</button>
    </div>
  </section>
</main>

<footer>
  <small class="small">Demo de “Mi Dolor” — tus datos se guardan solo en este navegador.</small>
</footer>

<script>
// --- Storage ---
const LS = { load(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch(_){ return d } }, save(k,v){ localStorage.setItem(k, JSON.stringify(v)) } };

// --- Settings & entries ---
const DEFAULT_SETTINGS = { variables: { stress:true, mood:true, busy:true, exercise:true, exerciseLegs:true, walkMin:true, standHours:true, hydration:true, alcohol:false, notes:true } };
let settings = LS.load('settings', DEFAULT_SETTINGS);
let entries = LS.load('entries_simple', []); // [{date, pain:{prevNight,morning,afternoon}, vars:{...}}]

// --- Date helpers ---
const fmtDate = (d)=> d.toISOString().slice(0,10);
const addDays = (d,n)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
let selectedDate = new Date();

function selectedISO(){ return fmtDate(selectedDate); }
function yesterdayISO(){ return fmtDate(addDays(selectedDate,-1)); }

// --- Upsert/Get ---
function upsert(iso){
  let e = entries.find(x=>x.date===iso);
  if(!e){ e = { date: iso, pain:{}, vars:{} }; entries.push(e); }
  return e;
}
function get(iso){ return entries.find(x=>x.date===iso); }
function saveAll(){ LS.save('entries_simple', entries); renderWeek(); renderSelectedLabel(); renderDataBox(); renderActivitiesForm(); renderStreak(); }

// --- Colored sliders ---
function thresholdColor(val){
  if(val <= 2) return getComputedStyle(document.documentElement).getPropertyValue('--green').trim();
  if(val <= 7) return getComputedStyle(document.documentElement).getPropertyValue('--yellow').trim();
  return getComputedStyle(document.documentElement).getPropertyValue('--red').trim();
}
function paintRange(el){
  const max=Number(el.max||10), min=Number(el.min||0), val=Number(el.value||0);
  const pct=((val-min)/(max-min))*100; const color=thresholdColor(val);
  el.style.background = `linear-gradient(to right, ${color} 0% ${pct}%, var(--track-bg) ${pct}% 100%)`;
}

// --- Elements ---
const sPrevNight = document.getElementById('painPrevNight');
const sMorning = document.getElementById('painMorning');
const sAfternoon = document.getElementById('painAfternoon');
const vPrevNight = document.getElementById('v-prevNight');
const vMorning = document.getElementById('v-morning');
const vAfternoon = document.getElementById('v-afternoon');
[sPrevNight,sMorning,sAfternoon].forEach(el=>{ el.addEventListener('input',()=>paintRange(el)); paintRange(el); });
sPrevNight.addEventListener('input', ()=> vPrevNight.textContent = sPrevNight.value);
sMorning.addEventListener('input', ()=> vMorning.textContent = sMorning.value);
sAfternoon.addEventListener('input', ()=> vAfternoon.textContent = sAfternoon.value);

// --- Save ---
document.getElementById('saveBtn').onclick = ()=>{
  const e = upsert(selectedISO());
  e.pain.prevNight = Number(sPrevNight.value);
  e.pain.morning = Number(sMorning.value);
  e.pain.afternoon = Number(sAfternoon.value);
  saveAll();
  document.getElementById('message').textContent = '✅ Guardado';
  setTimeout(()=> document.getElementById('message').textContent='', 1800);
};

// --- Data box ---
function renderDataBox(){
  const e = get(selectedISO());
  const box = document.getElementById('dataBox');
  if(!e || !e.pain || (e.pain.prevNight==null && e.pain.morning==null && e.pain.afternoon==null)){
    box.innerHTML = '<div class="small">Aún no hay datos guardados para este día.</div>';
    return;
  }
  box.innerHTML = `
    <div class="data-row"><span>Noche anterior</span><strong>${e.pain.prevNight ?? '-'}</strong></div>
    <div class="data-row"><span>Mañana</span><strong>${e.pain.morning ?? '-'}</strong></div>
    <div class="data-row"><span>Tarde</span><strong>${e.pain.afternoon ?? '-'}</strong></div>
  `;
}

// --- Activities (variables) ---
const VAR_DEFS = {
  stress:{ label:'Estrés (0–10)', type:'slider', min:0, max:10, step:1 },
  mood:{ label:'Estado de ánimo (0–10)', type:'slider', min:0, max:10, step:1 },
  busy:{ label:'Ocupación del día (0–10)', type:'slider', min:0, max:10, step:1 },
  exercise:{ label:'¿Hiciste ejercicios?', type:'toggle' },
  exerciseLegs:{ label:'¿Entrenaste piernas?', type:'toggle', dependsOn:'exercise' },
  walkMin:{ label:'Caminata (min)', type:'stepper', min:0, max:600, step:5 },
  standHours:{ label:'Tiempo de pie (horas)', type:'stepper', min:0, max:18, step:1 },
  hydration:{ label:'Hidratación (vasos)', type:'stepper', min:0, max:20, step:1 },
  alcohol:{ label:'¿Consumiste alcohol?', type:'toggle' },
  notes:{ label:'Notas', type:'text' }
};

function renderActivitiesForm(){
  const e = upsert(selectedISO());
  const cont = document.getElementById('activitiesForm');
  cont.innerHTML='';
  for(const key of Object.keys(VAR_DEFS)){
    if(!settings.variables[key]) continue;
    const def = VAR_DEFS[key];
    if(def.dependsOn && !e.vars[def.dependsOn]) continue;
    const row = document.createElement('div'); row.className='field';
    const label = document.createElement('label'); label.textContent = def.label; row.appendChild(label);
    switch(def.type){
      case 'slider': {
        const input=document.createElement('input'); input.type='range'; input.min=def.min; input.max=def.max; input.step=def.step; input.value=e.vars[key] ?? 0;
        const out=document.createElement('span'); out.className='value'; out.textContent=input.value;
        input.oninput=()=>{ e.vars[key]=Number(input.value); out.textContent=input.value; paintRange(input); saveAll(); };
        row.appendChild(input); row.appendChild(out); paintRange(input);
      } break;
      case 'toggle': {
        const sel=document.createElement('select');
        ['No','Sí'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
        sel.value = e.vars[key] ? 'Sí':'No';
        sel.onchange=()=>{ e.vars[key]=(sel.value==='Sí'); saveAll(); renderActivitiesForm(); };
        row.appendChild(sel);
      } break;
      case 'stepper': {
        const wrap=document.createElement('div'); wrap.className='stepper';
        const minus=document.createElement('button'); minus.textContent='–';
        const val=document.createElement('span'); val.textContent = e.vars[key] ?? 0;
        const plus=document.createElement('button'); plus.textContent='+';
        const clamp=(v)=> Math.min(def.max, Math.max(def.min, v));
        minus.onclick=(ev)=>{ ev.preventDefault(); e.vars[key]=clamp((e.vars[key]??0)-def.step); val.textContent=e.vars[key]; saveAll(); };
        plus.onclick=(ev)=>{ ev.preventDefault(); e.vars[key]=clamp((e.vars[key]??0)+def.step); val.textContent=e.vars[key]; saveAll(); };
        wrap.appendChild(minus); wrap.appendChild(val); wrap.appendChild(plus); row.appendChild(wrap);
      } break;
      case 'text': {
        const inp=document.createElement('input'); inp.type='text'; inp.placeholder='Escribe una nota (opcional)'; inp.value=e.vars[key] ?? '';
        inp.oninput=()=>{ e.vars[key]=inp.value; saveAll(); };
        row.appendChild(inp);
      } break;
    }
    cont.appendChild(row);
  }
}

// --- Settings list ---
function renderSettings(){
  const cont = document.getElementById('settings'); cont.innerHTML='';
  for(const key of Object.keys(VAR_DEFS)){
    const row=document.createElement('div'); row.className='field';
    const lab=document.createElement('label'); lab.textContent = VAR_DEFS[key].label;
    const input=document.createElement('input'); input.type='checkbox'; input.checked=!!settings.variables[key];
    input.onchange=()=>{ settings.variables[key]=input.checked; LS.save('settings', settings); renderActivitiesForm(); };
    row.appendChild(lab); row.appendChild(input); cont.appendChild(row);
  }
}

// --- Week bar ---
function startOfWeek(d){ const day=d.getDay(); return new Date(d.getFullYear(), d.getMonth(), d.getDate()-day); } // domingo
let weekStart = startOfWeek(selectedDate);
function labelFor(d){ const days=['Dom','Lun','Mar','Mié','Jue','Vie','Sáb']; return {dow:days[d.getDay()], num:String(d.getDate()).padStart(2,'0')}; }
function renderWeek(){
  const wrap=document.getElementById('weekDays'); wrap.innerHTML='';
  for(let i=0;i<7;i++){
    const d = addDays(weekStart, i);
    const iso = fmtDate(d);
    const {dow,num}=labelFor(d);
    const div=document.createElement('div'); div.className='day'; div.dataset.iso=iso;
    if(iso===selectedISO()) div.classList.add('selected');
    const e=get(iso); const completed = e && (e.pain && (e.pain.prevNight!=null || e.pain.morning!=null || e.pain.afternoon!=null));
    if(completed) div.classList.add('completed');
    div.innerHTML = `<div class="dow">${dow}</div><div class="num">${num}</div><div class="check">✓</div>`;
    div.onclick=()=>{ selectedDate = d; renderSelectedLabel(); renderWeek(); loadForm(); };
    wrap.appendChild(div);
  }
}
document.getElementById('prevWeek').onclick=()=>{ weekStart = addDays(weekStart, -7); renderWeek(); };
document.getElementById('nextWeek').onclick=()=>{ weekStart = addDays(weekStart, +7); renderWeek(); };
function renderSelectedLabel(){
  const d=selectedDate; const opts={ weekday:'long', year:'numeric', month:'long', day:'numeric' };
  document.getElementById('selectedDateLabel').textContent = `Estás registrando: ${d.toLocaleDateString('es-ES', opts)}`;
}

// --- Streak ---
function renderStreak(){
  let streak=0; let d=new Date();
  while(true){
    const iso=fmtDate(d); const e=get(iso);
    if(e && e.pain && (e.pain.prevNight!=null || e.pain.morning!=null || e.pain.afternoon!=null)){
      streak++; d=addDays(d,-1);
    }else break;
  }
  document.getElementById('streak').textContent = `Racha: ${streak} días`;
}

// --- Load form for selected ---
function loadForm(){
  const e = upsert(selectedISO());
  sPrevNight.value = e.pain.prevNight ?? 0; vPrevNight.textContent = sPrevNight.value; paintRange(sPrevNight);
  sMorning.value = e.pain.morning ?? 0; vMorning.textContent = sMorning.value; paintRange(sMorning);
  sAfternoon.value = e.pain.afternoon ?? 0; vAfternoon.textContent = sAfternoon.value; paintRange(sAfternoon);
  renderActivitiesForm();
  renderDataBox();
}

// --- Export/Import ---
document.getElementById('exportBtn').onclick=()=>{
  const blob = new Blob([JSON.stringify({settings, entries}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mi_dolor_datos.json'; a.click(); URL.revokeObjectURL(url);
};
document.getElementById('importBtn').onclick=()=> document.getElementById('importFile').click();
document.getElementById('importFile').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return; const reader=new FileReader();
  reader.onload=()=>{ try{ const data=JSON.parse(reader.result);
      settings=data.settings||settings; entries=data.entries||entries;
      LS.save('settings', settings); LS.save('entries_simple', entries);
      renderSettings(); renderWeek(); renderSelectedLabel(); loadForm(); renderStreak();
      alert('Importado correctamente');
    }catch(err){ alert('Archivo inválido'); } };
  reader.readAsText(f);
};

// --- Init ---
function init(){
  renderSettings();
  renderWeek();
  renderSelectedLabel();
  loadForm();
  renderStreak();
}
init();
</script>
</body>
</html>
